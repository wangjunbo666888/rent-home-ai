<view class="page-mine">
  <view class="header-bar">
    <text class="header-title">我的</text>
  </view>

  <scroll-view class="main-scroll" scroll-y enhanced show-scrollbar="{{false}}">
    <view class="card user-card" wx:if="{{!loading && !loggedIn}}">
      <text class="guest-tip">您还未登录</text>
      <button class="btn-primary" bindtap="goLogin">去登录</button>
    </view>

    <block wx:if="{{!loading && loggedIn}}">
      <view class="card user-card">
        <view class="user-avatar">
          <text class="avatar-placeholder">{{user.avatarText}}</text>
        </view>
        <view class="user-info">
          <view class="info-row">
            <text class="info-line">
              <text class="info-label">手机号</text> <text class="info-value">{{user.phoneMasked}}</text>
            </text>
          </view>
          <view class="info-row">
            <text class="info-line">
              <text class="info-label">订阅状态</text> <text class="info-value {{hasActiveSubscription ? 'status-ok' : 'status-none'}}">{{hasActiveSubscription && subscriptionExpireAt ? ('已开通至 ' + subscriptionExpireAt) : '未开通'}}</text>
            </text>
          </view>
        </view>
      </view>

      <view class="card action-card">
        <view class="card-title">订阅服务</view>
        <text class="card-desc">开通后可使用智能匹配与地址联想功能</text>
        <button class="btn-primary" bindtap="goSubscribe">
          {{hasActiveSubscription ? '续费' : '开通订阅'}}
        </button>
      </view>

      <view class="card extra-card" wx:if="{{orders.length > 0}}">
        <view class="card-title">我的订单</view>
        <view
          class="order-row"
          wx:for="{{orders}}"
          wx:key="id"
        >
          <text class="order-line">
            <text class="order-id">{{item.id}} </text>
            <text class="order-plan">{{item.plan === 'month' ? '月付' : '季付'}} </text>
            <text class="order-status {{item.payStatus === 'paid' ? 'paid' : ''}}">{{item.payStatus === 'paid' ? '已支付' : '待支付'}}</text>
            <text class="order-expire" wx:if="{{item.expireAtShort}}"> 至 {{item.expireAtShort}}</text>
          </text>
        </view>
      </view>

      <view class="logout-wrap">
        <button class="btn-logout" bindtap="onLogout">退出登录</button>
      </view>
    </block>

    <view class="loading-tip" wx:if="{{loading}}">加载中...</view>
  </scroll-view>
</view>
